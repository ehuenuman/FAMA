{% extends 'teacher/base.html' %}
{% load staticfiles %}

{% block extracss%}
<style>
  .flex-container {
    display: -webkit-flex;
    display: flex;
  }

  .flex-container .col {
    height: auto;
  }

  .flex-container .col .col {
    height: 100%;
  }

  .reply {
    border-radius: 0px;
  }

  .reply.correct {
    background-color: #4caf50;
  }

  .reply.incorrect {
    background-color: #f44336;
  }
</style>
{% endblock %}

{% block extrajs%}
{% endblock %}

{% block title %}
FAMA - Resultados Formativa
{% endblock %}

{% block page-title %}
Resultados
{% endblock %}


{% block content %}
<div class="row">
  <div class="col s12">
    <div style="overflow-x: auto;">
      <table class="card-box" style="font-size: 13px;">
        <thead>          
          <tr>
            <th style="width: 250px;">Estudiante</th>
            {% for question in questions %}
              <th class="center-align" data-question="{{ question.id }}">P{{ forloop.counter }} {{ question.title|truncatechars_html:20 }}</th>
            {% endfor %}
            <th class="center-align" style="width: 100px;">Total</th>
          </tr>
        </thead>
        <tbody>        
          {% for student in students %}
            <tr>
              <td class="truncate" data-student="{{ student.id }}">{{ student.first_name|title }} {{ student.last_name|title }}</td>
              {% for question in questions %}
                <td data-student="{{ student.id }}" data-question="{{ question.id }}"
                  {% for answer in student.answers %}        
                    {% if answer.question == question.id %}
                      {% if answer.correct == 1 %}
                         class="center-align reply correct">
                          <i class="fa fa-check fa-lg" aria-hidden="true"></i>
                      {% else %}
                        class="center-align reply incorrect">
                          <i class="fa fa-times fa-lg" aria-hidden="true"></i>
                      {% endif %}
                    {% endif %}
                  {% endfor %} 
                  </td>
              {% endfor %}
              <td class="center-align">{{ student.corrects }}</td>
            </tr>
          {% endfor %}
          <tr>
            <td><b>Total</b></td>
            {% for question in questions %}
              <td class="center-align" data-question="{{ question.id }}">
              {% for total in total_for_question %}
                {% if total.question == question.id %}
                  {{ total.correct__sum }}
                {% endif %}
              {% endfor %}
              </td>
            {% endfor %}
            <td></td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}

{% block footer %}
{% endblock %}

{% block js %}
<script>
  var ws_scheme = window.location.protocol == "https:" ? "wss" : "ws";
  var ws_url = ws_scheme + "://" + window.location.hostname + ":2412" + "/ws/play/" 
    + window.location.pathname.split("/")[3] + "/" + "?session_key={{ request.session.session_key }}";

  //console.log("Conecting to... " + ws_url)

  var socket = new WebSocket(ws_url);

  socket.onmessage = function(e) {
    var data = JSON.parse(e.data);
    var cell = $("td[data-student='"+data.student+"'][data-question='"+data.question+"']");

    if (cell.hasClass("reply correct")) {
      if (data.correct == 0) {
        cell
          .removeClass('correct')
          .empty()
          .addClass("incorrect")
          .append('<i class="fa fa-times fa-lg" aria-hidden="true"></i>');
        var student_total = parseInt(cell.parent().children().last().html());
        if (student_total > 0) {
          cell.parent().children().last().html(student_total-1);
        }
        var question_total = parseInt($("td[data-question='"+data.question+"']").last().html());
        if (isNaN(question_total)) {
          $("td[data-question='"+data.question+"']").last().html(1);
        } else {
          if (question_total > 0) {
            $("td[data-question='"+data.question+"']").last().html(question_total-1);
          }
        }
      }
    } else {
      if (cell.hasClass("reply incorrect")) {
        if (data.correct == 1) {
          cell
            .removeClass('incorrect')
            .empty()
            .addClass("correct")
            .append('<i class="fa fa-check fa-lg" aria-hidden="true"></i>');
          var student_total = parseInt(cell.parent().children().last().html());
          if (student_total >= 0) {
            cell.parent().children().last().html(student_total+1);
          }
          var question_total = parseInt($("td[data-question='"+data.question+"']").last().html());
          if (isNaN(question_total)) {
            $("td[data-question='"+data.question+"']").last().html(1);
          } else {
            if (question_total >= 0) {
              $("td[data-question='"+data.question+"']").last().html(question_total+1);
            }        
          }
        }
      } else {        
        if (data.correct == 0) {
          cell            
            .empty()
            .addClass("center-align reply incorrect")
            .append('<i class="fa fa-times fa-lg" aria-hidden="true"></i>');          
          var question_total = parseInt($("td[data-question='"+data.question+"']").last().html());
          if (isNaN(question_total)) {
            $("td[data-question='"+data.question+"']").last().html(0);
          } else {
            if (question_total > 0) {
              $("td[data-question='"+data.question+"']").last().html(question_total-1);
            }        
          }
        } else {
          cell
            .empty()
            .addClass("center-align reply correct")
            .append('<i class="fa fa-check fa-lg" aria-hidden="true"></i>');
          var student_total = parseInt(cell.parent().children().last().html());
          if (student_total >= 0) {
            cell.parent().children().last().html(student_total+1);
          }
          var question_total = parseInt($("td[data-question='"+data.question+"']").last().html());
          if (isNaN(question_total)) {
            $("td[data-question='"+data.question+"']").last().html(1);
          } else {
            if (question_total >= 0) {
              $("td[data-question='"+data.question+"']").last().html(question_total+1);
            }
          }
        }
      }
    }
  }

  // Call onopen directly if socket is already open
  if (socket.readyState == WebSocket.OPEN) socket.onopen();
</script>
{% endblock %}